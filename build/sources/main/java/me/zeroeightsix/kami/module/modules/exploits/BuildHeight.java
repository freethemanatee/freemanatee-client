package me.zeroeightsix.kami.module.modules.exploits;

import me.zero.alpine.listener.EventHandler;
import me.zero.alpine.listener.Listener;
import me.zeroeightsix.kami.event.events.PacketEvent;
import me.zeroeightsix.kami.module.Module;
import me.zeroeightsix.kami.setting.Setting;
import me.zeroeightsix.kami.setting.Settings;
import net.minecraft.network.play.client.CPacketPlayerTryUseItemOnBlock;
import net.minecraft.util.EnumFacing;

/**
 * Created 14 November 2019 by 3arthqu4ke
 * Updated 15 November 2019 by hub
 */
@Module.Info(name = "BuildHeight", category = Module.Category.EXPLOITS)
public class BuildHeight extends Module {

    private Setting<Integer> height = register(Settings.i("Height", 255));

    @EventHandler
    private Listener<PacketEvent.Send> packetListener = new Listener<>(event -> {

        // skip if packet is not CPacketPlayerTryUseItemOnBlock
        if (!(event.getPacket() instanceof CPacketPlayerTryUseItemOnBlock)) {
            return;
        }
        final CPacketPlayerTryUseItemOnBlock oldPacket = (CPacketPlayerTryUseItemOnBlock) event.getPacket();

        // skip if block is not >= height
        if (oldPacket.getPos().getY() < height.getValue()) {
            return;
        }

        // skip if click was not on EnumFacing.UP
        if (oldPacket.getDirection() != EnumFacing.UP) {
            return;
        }

        // TODO - calculate optimal side to click on (for servers with raytracing)

        // send replacement packet
        mc.player.connection.sendPacket(new CPacketPlayerTryUseItemOnBlock(oldPacket.getPos(), EnumFacing.DOWN, oldPacket.getHand(), oldPacket.getFacingX(), oldPacket.getFacingY(), oldPacket.getFacingZ()));
        event.cancel();

    });

}
