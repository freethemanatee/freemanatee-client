package me.zopac.freemanatee.module.modules.exploits

import me.zero.alpine.listener.EventHandler
import me.zero.alpine.listener.EventHook
import me.zero.alpine.listener.Listener
import me.zopac.freemanatee.event.events.PacketEvent
import me.zopac.freemanatee.module.Module
import me.zopac.freemanatee.setting.Settings
import net.minecraft.network.play.client.CPacketPlayerDigging

@Module.Info(
        name = "PacketMine",
        category = Module.Category.PLAYER
)

class PacketMine : Module() {

    private var packetMine = true
    private val sneakTrigger = false

    @EventHandler
    private val sendListener = Listener(EventHook { event: PacketEvent.Send ->
        if (event.packet !is CPacketPlayerDigging || !packetMine == true || !((sneakTrigger == false && mc.player.isSneaking) || !sneakTrigger == false)) return@EventHook
        val packet = event.packet as CPacketPlayerDigging

        if (packet.action == CPacketPlayerDigging.Action.START_DESTROY_BLOCK) {
            Thread(Runnable{
                val startTime = System.currentTimeMillis()
                while (!mc.world.isAirBlock(packet.position) && System.currentTimeMillis() - startTime < 10000L) {
                    mc.connection!!.sendPacket(CPacketPlayerDigging(CPacketPlayerDigging.Action.STOP_DESTROY_BLOCK, packet.position, packet.facing))
                    Thread.sleep(200L)
                }
            }).start()
        } else if (packet.action == CPacketPlayerDigging.Action.ABORT_DESTROY_BLOCK) {
            event.cancel() /* Cancels aborting packets */
        }
    })
}